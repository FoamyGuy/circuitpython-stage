from micropython import const
import board
import busio
import digitalio
import time
import ugame
import stage
import array


_FONT = (
    b'{{{{{{wws{w{HY{{{{YDYDY{sUtGUsH[wyH{uHgHE{ws{{{{vyxyv{g[K[g{{]f]{{{wDw{{'
    b'{{{wy{{{D{{{{{{{w{K_w}x{VHLHe{wuwww{`KfyD{UKgKU{w}XDK{DxTKT{VxUHU{D[wyx{'
    b'UHfHU{UHEKe{{w{w{{{w{wy{KwxwK{{D{D{{xwKwx{eKg{w{VIHyB{fYH@H{dHdHd{FyxyF{'
    b'`XHX`{DxtxD{Dxtxx{FyxIF{HHDHH{wwwww{KKKHU{HXpXH{xxxxD{Y@DLH{IL@LX{fYHYf{'
    b'`HH`x{fYHIF{`HH`H{UxUKU{Dwwww{HHHIR{HHH]w{HHLD@{HYsYH{HYbww{D[wyD{txxxt{'
    b'x}w_K{GKKKG{wLY{{{{{{{{Dxs{{{{{BIIB{x`XX`{{ByyB{KBIIB{{WIpF{OwUwww{`YB[`'
    b'x`XHH{w{vwc{K{OKHUxHpXH{vwws_{{dD@H{{`XHH{{fYYf{{`XX`x{bYIBK{Ipxx{{F}_d{'
    b'wUws_{{HHIV{{HH]s{{HLD@{{HbbH{{HHV[a{D_}D{Cw|wC{wwwwwwpwOwp{WKfxu{@YYY@{'
)
_SALT = const(132)
_BANK = (
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00""""""\x00\x02"""""" \x02'
    b'\x02\x02\x02\x02\x02\x02\x00\x00       \x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x02\x02\x02\x02\x02\x02\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00 \x00 \x00 \x00 \x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00 \x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02h\xb8\xb8\xb8\xb8'
    b'\xb6 \x08\x88\x88\x88\x88\x88\x88\x80\x08hhhhhh`\x06\x86\x86\x86\x86'
    b'\x86\x86\x80\x06ffffff`\x08hhhhhh`\x06ffffff`\x06FFFFFF@\x04dddddd`\x04D'
    b'DDDDD@\x06FFFFFF@\x04DDDDDD@\x04dDdDdD`\x02DDDDDD \x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x029\x99\x99\x99\x99\x93 '
    b'\t\x99\x99\x99\x99\x99\x99\x90\t9999990\x03\x93\x93\x93\x93\x93\x93\x90'
    b'\x033333330\t9999990\x033333330\x03\x13\x13\x13\x13\x13\x13\x10\x0111111'
    b'10\x01\x11\x11\x11\x11\x11\x11\x10\x03\x13\x13\x13\x13\x13\x13\x10\x01'
    b'\x11\x11\x11\x11\x11\x11\x10\x011\x111\x111\x110\x02\x11\x11\x11\x11\x11'
    b'\x11 \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x02\xce\xee\xee\xee\xee\xec \x0e\xee\xee\xee\xee\xee\xee\xe0\x0c\xec'
    b'\xec\xec\xec\xec\xec\xe0\x0e\xee\xee\xee\xee\xee\xee\xe0\x0e\xce\xce\xce'
    b'\xce\xce\xce\xc0\x0c\xec\xec\xec\xec\xec\xec\xe0\x0c\xcc\xcc\xcc\xcc\xcc'
    b'\xcc\xc0\x0e\xce\xce\xce\xce\xce\xce\xc0\x0c\xcc\xcc\xcc\xcc\xcc\xcc\xc0'
    b'\x0c\xac\xac\xac\xac\xac\xac\xa0\n\xca\xca\xca\xca\xca\xca\xc0\n\xaa\xaa'
    b'\xaa\xaa\xaa\xaa\xa0\x0c\xac\xac\xac\xac\xac\xac\xa0\x02\xaa\xaa\xaa\xaa'
    b'\xaa\xaa \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\'wwwwr\x00\x07wwwwwwp\x02rrrrrrp\x07wwwwwwp\x07\'\'\'\'\'\' '
    b'\x02rrrrrrp\x02"""""" \x07\'\'\'\'\'\' \x02"""""" \x02\x02\x02\x02\x02'
    b'\x02\x02\x00\x00       \x00\x00\x00\x00\x00\x00\x00\x00\x02\x02\x02\x02'
    b'\x02\x02\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x8b\xbb\xbb\xbb\xbb\xb8 '
    b'\x0b\xbb\xbb\xbb\xbb\xbb\xbb\xb0\x08\xb8\xb8\xb8\xb8\xb8\xb8\xb0\x0b'
    b'\xbb\xbb\xbb\xbb\xbb\xbb\xb0\x0b\x8b\x8b\x8b\x8b\x8b\x8b\x80\x08\xb8'
    b'\xb8\xb8\xb8\xb8\xb8\xb0\x08\x88\x88\x88\x88\x88\x88\x80\x0b\x8b\x8b'
    b'\x8b\x8b\x8b\x8b\x80\x08\x88\x88\x88\x88\x88\x88\x80\x06\x86\x86\x86'
    b'\x86\x86\x86\x80\x08hhhhhh`\x06ffffff`\x06\x86\x86\x86\x86\x86\x86\x80'
    b'\x02ffffff \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x02\x9a\xaa\xaa\xaa\xaa\xa9 \n\xaa\xaa\xaa\xaa\xaa\xaa\xa0\t\xa9'
    b'\xa9\xa9\xa9\xa9\xa9\xa0\n\xaa\xaa\xaa\xaa\xaa\xaa\xa0\n\x9a\x9a\x9a\x9a'
    b'\x9a\x9a\x90\t\xa9\xa9\xa9\xa9\xa9\xa9\xa0\t\x99\x99\x99\x99\x99\x99\x90'
    b'\n\x9a\x9a\x9a\x9a\x9a\x9a\x90\t\x99\x99\x99\x99\x99\x99\x90\t9999990'
    b'\x03\x93\x93\x93\x93\x93\x93\x90\x033333330\t9999990\x02333333 \x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xee\xee\xee'
    b'\xee\xee\xee \x0e\xee\xee\xee\xee\xee\xee\xe0\x0e\xee\xce\xee\xce\xee'
    b'\xce\xe0\x0e\xee\xee\xee\xee\xee\xee\xe0\x0c\xec\xec\xec\xec\xec\xec\xe0'
    b'\x0e\xee\xee\xee\xee\xee\xee\xe0\x0e\xce\xce\xce\xce\xce\xce\xc0\x0c\xec'
    b'\xec\xec\xec\xec\xec\xe0\x0c\xcc\xcc\xcc\xcc\xcc\xcc\xc0\x0e\xce\xce\xce'
    b'\xce\xce\xce\xc0\x0c\xcc\xcc\xcc\xcc\xcc\xcc\xc0\x0c\xcc\xec\xcc\xec\xcc'
    b'\xec\xc0\x0c\xcc\xcc\xcc\xcc\xcc\xcc\xc0\x02\xcc\xcc\xcc\xcc\xcc\xcc '
    b'\x00\x00\x00\x00\x00\x00\x00\x00\x88f\x88f\x88f\x88f\x88f\x88f\x88f\x88'
    b'ff\x88f\x88f\x88f\x88\x00\x00\x00\x00\x00\x00\x00\x00\xee\xee\xee\xee'
    b'\xee\xee\xee\xee\xdd\xdd\xdd\xdd\xdd\xdd\xdd\xdd\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\'\'\'\'\'\'\'\'wwwwwwwwrrrrrrrrwwwwwwww\'\'\'\'\'\'\'\'wwwwwwww'
    b'rrrrrrrrwwwwwwww\'\'\'\'\'\'\'\'\x88f\x88f\x88f\x88f\x88f\x88f\x88f\x88f'
    b'f\x88f\x88f\x88f\x88f\x88f\x88f\x88d\x00\x88f\x88f\x88f\x02\xde\x88f\x88'
    b'f\x88d.\xedf\x88f\x88f\x80\xde\xd7f\x88f\x88f\x80\xedp\x88f\x88f\x88`'
    b'\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80\xed\x07f\x88f\x88f\x80'
    b'\xed\x07\x88f\x88f\x88`\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80'
    b'\xed\x07f\x88f\x88f\x80\xed\x07\x88f\x88f\x88`\xed\x07\x88f\x88f\x88`'
    b'\xed\x02f\x88f\x88f\x80\xed\x07f\x88f\x88f\x80\xed\x07\x88f\x88f\x88`'
    b'\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80\xed\x07f\x88f\x88f\x80'
    b'\xed\x07\x88f\x88f\x88`\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80'
    b'\xed\x07f\x88f\x88f\x80\xed\x07\x88f\x88f\x88`\xed\x07\x88f\x88f\x88`'
    b'\xed\x02f\x88f\x88f\x80\xed\x07f\x88f\x88f\x80\xed\x07\x88f\x88f\x88`'
    b'\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80\xed\x07f\x88f\x88f\x80'
    b'\xed\x07\x88f\x88f\x88`\xed\x07\x88f\x88f\x88`\xed\x02f\x88f\x88f\x80'
    b'\xed\x07f\x88f\x88f\x80\xed\x07\x88f\x88f\x88`\xder\x88f\x88f\x88`~\xedf'
    b'\x88f\x88f\x84-\xdef\x88f\x88f\x86\x02}\x88f\x88f\x88fd\x00\x88f\x88f'
    b'\x88f\x86Df\x88f\x88f\x88fff\x88f\x88f\x88f\x88wwwwwwwwrrrrrrrrwwwwwwww'
    b'\'\'\'\'\'\'\'\'wwwwwwwwrrrrrrrrwwwwwwww\'\'\'\'\'\'\'\'wwwwwwww\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\xee\xee\xee\xee\xee\xee\xee\xee\xdd\xdd\xdd\xdd'
    b'\xdd\xdd\xdd\xdd\x00\x00\x00\x00\x00\x00\x00\x00\x88f\x88f\x88f\x88ff'
    b'\x88f\x88f\x88f\x88f\x88f\x88f\x88f\x88wwwwwwwwrrrrrrrrwwwwwwww\'\'\'\''
    b'\'\'\'\'wwwwwwwwrrrrrrrrwwwwwwww\'\'\'\'\'\'\'\'wwwwwwwwrrrrrrrrwwwwwwww'
    b'\'\'\'\'\'\'\'\'wwwwwwwwrrrrrrrrwwwwwwww\'\'\'\'\'\'\'\'UUUUUUUUUUUUUUUU'
    b'UU \x02UUUU\x02R\xde\xee \x00\x00%\r\x0e\xee\xde\xe7\xee\xee\xd2\x0e~'
    b'\xee}\xe7\xdd\xdd\xd2\x0e\xdd\xee}\xe7p\x00%\x0e\xdd\xdd}\xd7\xe0UU\x0e'
    b'\xddw\xe7~\xd0UU\x0e\xde\xdd~\xe7pUU\x0e~\xd7\xe7\xde\xd2UU\r\r\xd7\xdew'
    b'\x05UU\x02R\xdd}\xed%UUUU \x00\x02UUUUUUUUUUUUUUUUUUU')

_PALETTE = array.array('H', [0, 176, 11321, 248, 16418, 8184, 8259, 65402, 92,
                             27130, 43260, 57501, 33022, 47830, 56319, 8184])


K_X = 0x01
K_DOWN = 0x02
K_LEFT = 0x04
K_RIGHT = 0x08
K_UP = 0x10
K_O = 0x20

_tick = None
_display = None


def brightness(level):
    pass


def show(pix):
    for y in range(8):
        for x in range(8):
            _grid.tile(x + 1, y, 1 + (pix.pixel(x, y) & 0x03))
    _game.render_block(16, 0, 144, 128)

keys = ugame.buttons.get_pressed


def tick(delay):
    global _tick

    now = time.monotonic()
    _tick += delay
    if _tick < now:
        _tick = now
    else:
        time.sleep(_tick - now)


class GameOver(Exception):
    pass


class Pix:
    __slots__ = ('buffer', 'width', 'height')

    def __init__(self, width=8, height=8, buffer=None):
        if buffer is None:
            buffer = bytearray(width * height)
        self.buffer = buffer
        self.width = width
        self.height = height

    @classmethod
    def from_text(cls, string, color=None, bgcolor=0, colors=None):
        pix = cls(4 * len(string), 6)
        font = memoryview(_FONT)
        if colors is None:
            if color is None:
                colors = (3, 2, bgcolor, bgcolor)
            else:
                colors = (color, color, bgcolor, bgcolor)
        x = 0
        for c in string:
            index = ord(c) - 0x20
            if not 0 <= index <= 95:
                continue
            row = 0
            for byte in font[index * 6:index * 6 + 6]:
                unsalted = byte ^ _SALT
                for col in range(4):
                    pix.pixel(x + col, row, colors[unsalted & 0x03])
                    unsalted >>= 2
                row += 1
            x += 4
        return pix

    @classmethod
    def from_iter(cls, lines):
        pix = cls(len(lines[0]), len(lines))
        y = 0
        for line in lines:
            x = 0
            for pixel in line:
                pix.pixel(x, y, pixel)
                x += 1
            y += 1
        return pix

    def pixel(self, x, y, color=None):
        if not 0 <= x < self.width or not 0 <= y < self.height:
            return 0
        if color is None:
            return self.buffer[x + y * self.width]
        self.buffer[x + y * self.width] = color

    def box(self, color, x=0, y=0, width=None, height=None):
        x = min(max(x, 0), self.width - 1)
        y = min(max(y, 0), self.height - 1)
        width = max(0, min(width or self.width, self.width - x))
        height = max(0, min(height or self.height, self.height - y))
        for y in range(y, y + height):
            xx = y * self.width + x
            for i in range(width):
                self.buffer[xx] = color
                xx += 1

    def blit(self, source, dx=0, dy=0, x=0, y=0,
             width=None, height=None, key=None):
        if dx < 0:
            x -= dx
            dx = 0
        if x < 0:
            dx -= x
            x = 0
        if dy < 0:
            y -= dy
            dy = 0
        if y < 0:
            dy -= y
            y = 0
        width = min(min(width or source.width, source.width - x),
                    self.width - dx)
        height = min(min(height or source.height, source.height - y),
                     self.height - dy)
        source_buffer = memoryview(source.buffer)
        self_buffer = self.buffer
        if key is None:
            for row in range(height):
                xx = y * source.width + x
                dxx = dy * self.width + dx
                self_buffer[dxx:dxx + width] = source_buffer[xx:xx + width]
                y += 1
                dy += 1
        else:
            for row in range(height):
                xx = y * source.width + x
                dxx = dy * self.width + dx
                for col in range(width):
                    color = source_buffer[xx]
                    if color != key:
                        self_buffer[dxx] = color
                    dxx += 1
                    xx += 1
                y += 1
                dy += 1

    def __str__(self):
        return "\n".join(
            "".join(
                ('.', '+', '*', '@')[self.pixel(x, y)]
                for x in range(self.width)
            )
            for y in range(self.height)
        )


def init():
    global _tick, _display, _gamepad, _bitmap, _grid, _game

    if _tick is not None:
        return

    _tick = time.monotonic()

    _game = stage.Stage(ugame.display, 12)
    tiles = stage.Bank(_BANK, _PALETTE)
    _grid = stage.Grid(tiles, 10, 8)
    _grid.move(0, 0)
    _game.layers = [_grid]
    _game.render_block()
